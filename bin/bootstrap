#!/bin/bash
set -euo pipefail

dir=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

gcloud container clusters get-credentials --project ai2-reviz --zone us-west1-b skiff-prod
prod=$(kubectl get secret/cfg --namespace olmo-api --output jsonpath="{.data.config\.json}" | base64 -D)

local=$(cat <<EOF
{
  "db": {
    "conninfo": "postgres://app:llmz@db:5432/llmx?sslmode=disable",
    "min_size": 1,
    "max_size": 2
  },
  "server": {
    "proxies": 1,
    "admins": [ "murphy@localhost" ],
    "origin": "http://localhost:8000",
    "ui_origin": "http://localhost:8080"
  },
  "google_cloud_services": {
    "enable_recaptcha": false,
    "require_recaptcha": false
  },
  "feature_flags": {
    "enable_dynamic_model_config": true
  },
  "infini_gram": {
    "api_url": "https://infinigram-api.allen.ai"
  }
}
EOF
)

# Merge the local defaults into the production config.
echo "$prod" "$local" | jq -s '.[0] * .[1]' > "$dir/../config.json"
echo "wrote \"$dir/../config.json\""

kubectl get secret/cfg --namespace olmo-api --output jsonpath="{.data.service_account\.json}" | base64 -D > "$dir/../service_account.json"
echo "wrote \"$dir/../service_account.json\""